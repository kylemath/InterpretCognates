{"role":"user","message":{"content":[{"type":"text","text":"<user_query>\nYou are working on /Users/kylemathewson/InterpretCognates.\n\n## Context\nThe blog at `/Users/kylemathewson/InterpretCognates/backend/app/static/blog.html` has a section 6.5 about \"Semantic Offset Invariance\" which tests whether relationships like man→woman produce parallel offset vectors across languages. The precomputed data at `/Users/kylemathewson/InterpretCognates/backend/app/data/results/offset_invariance.json` has per-language consistency scores for each concept pair.\n\n## Your Task: Add a \"best vector offset example\" visualization\n\n### 1. Update the precompute script\n\nIn `/Users/kylemathewson/InterpretCognates/backend/app/scripts/precompute.py`, modify the `run_offset_invariance()` function to also save a \"best pair vector plot\" dataset. After computing the offset invariance pairs, find the pair with the highest mean_consistency. For that best pair (e.g. man→woman), save the actual offset vectors projected into 2D:\n\nAdd this code AFTER the existing `pairs = semantic_offset_invariance(...)` call but BEFORE `save_result`:\n\n```python\n# Find best pair for vector visualization\nbest_pair = max(pairs, key=lambda p: p[\"mean_consistency\"])\nconcept_a = best_pair[\"concept_a\"]\nconcept_b = best_pair[\"concept_b\"]\n\n# Collect per-language offset vectors\nfrom sklearn.decomposition import PCA as PCA2D\noffset_vectors = []\noffset_langs = []\nfor lang in languages:\n    if lang in concept_embeddings.get(concept_a, {}) and lang in concept_embeddings.get(concept_b, {}):\n        vec_a = concept_embeddings[concept_a][lang]\n        vec_b = concept_embeddings[concept_b][lang]\n        offset_vectors.append(vec_b - vec_a)\n        offset_langs.append(lang)\n\nif len(offset_vectors) >= 3:\n    offset_array = np.array(offset_vectors)\n    centroid_offset = offset_array.mean(axis=0)\n    \n    # Project offsets to 2D via PCA\n    pca = PCA2D(n_components=2)\n    projected = pca.fit_transform(offset_array)\n    centroid_2d = pca.transform(centroid_offset.reshape(1, -1))[0]\n    \n    from app.benchmarks import LANGUAGE_FAMILY_MAP\n    vector_plot_data = {\n        \"concept_a\": concept_a,\n        \"concept_b\": concept_b,\n        \"mean_consistency\": float(best_pair[\"mean_consistency\"]),\n        \"centroid\": {\"x\": float(centroid_2d[0]), \"y\": float(centroid_2d[1])},\n        \"per_language\": [\n            {\n                \"lang\": offset_langs[i],\n                \"family\": LANGUAGE_FAMILY_MAP.get(offset_langs[i], \"Unknown\"),\n                \"x\": float(projected[i, 0]),\n                \"y\": float(projected[i, 1]),\n            }\n            for i in range(len(offset_langs))\n        ],\n        \"explained_variance\": [float(v) for v in pca.explained_variance_ratio_],\n    }\nelse:\n    vector_plot_data = None\n```\n\nThen update the save_result call to include:\n```python\nsave_result(\"offset_invariance\", {\n    \"num_pairs\": len(pairs),\n    \"num_languages\": len(languages),\n    \"pairs\": pairs,\n    \"vector_plot\": vector_plot_data,\n})\n```\n\nNote: `concept_embeddings` and `languages` are already parameters of `run_offset_invariance`. You just need to add `from sklearn.decomposition import PCA as PCA2D` at the top of the function (or import at module level — check what's already imported).\n\nActually, looking at the imports, the module already imports from app.modeling which uses PCA. Just use:\n```python\nfrom sklearn.decomposition import PCA\n```\nAdd it near the top of the file if not already there. Use a local alias if PCA is already imported:\n```python\npca_2d = PCA(n_components=2)\n```\n\n### 2. Add the renderer in blog.js\n\nIn `/Users/kylemathewson/InterpretCognates/backend/app/static/blog.js`, add a new function `renderVectorOffsetExample(data)` that:\n\n1. Reads `data.vector_plot` \n2. If null/missing, hides the container\n3. Groups the per_language points by family\n4. Creates a 2D scatter plot where each point is an offset vector, colored by language family\n5. Draws an arrow from origin (0,0) to the centroid point as a thick line with an annotation arrow\n6. Title: \"Best Offset Example: {concept_a} → {concept_b} (consistency: {value})\"\n\nUse the existing `FAMILY_COLORS` and `familyColor()` for coloring. Use `LANG_FAMILY` mapping or the data's `family` field.\n\nThe Plotly traces should be:\n- One trace per family (scatter, markers+text, colored by family)\n- One trace for the centroid arrow (scatter, lines+markers, thick red line from [0,0] to centroid, with a triangle marker at the end)\n- Layout: height 480, xaxis title \"PC1\", yaxis title \"PC2\"\n\nAdd the call in the init() function, in the Section 6 area, right after `safeRender(\"offsetStats\", ...)`:\n```javascript\nsafeRender(\"vectorOffset\", () => renderVectorOffsetExample(offset));\n```\n\n### 3. Add HTML container in blog.html\n\nIn `/Users/kylemathewson/InterpretCognates/backend/app/static/blog.html`, find the section about Semantic Offset Invariance (section 6.5). Right AFTER the offset stat badges div and BEFORE the offset bar chart figure, add:\n\n```html\n  <div class=\"figure\">\n    <div class=\"figure-inner\">\n      <div id=\"vectorOffsetPlot\" class=\"chart\">\n        <div class=\"loading-placeholder\"><span class=\"spinner\"></span> Loading&hellip;</div>\n      </div>\n    </div>\n    <p class=\"figure-caption\">\n      <strong>Figure 11b.</strong> 2D PCA projection of per-language semantic offset vectors for the\n      most translationally invariant concept pair. Each arrow represents the offset vector in one\n      language, colored by family. The red arrow shows the cross-lingual centroid. Tightly clustered,\n      parallel arrows indicate the relationship is encoded identically across languages.\n    </p>\n  </div>\n```\n\nInsert this AFTER the `<div id=\"offsetStats\"...>` block and BEFORE the existing `<div class=\"figure\">` that contains `offsetChart`.\n\nRead all files before editing. Make targeted edits only.\n</user_query>"}]}}
{"role":"assistant","message":{"content":[{"type":"text","text":"Let me start by reading all the relevant files to understand the current state before making any edits."}]}}
{"role":"assistant","message":{"content":[{"type":"text","text":"I've read all three files. Now I'll make the targeted edits across all three files.\n\nNow I have a clear picture of all three files. Let me make the targeted edits:\n\n1. **precompute.py**: Modify `run_offset_invariance()` to add vector plot data computation and update the `save_result` call.\n2. **blog.js**: Add `renderVectorOffsetExample()` function and its call in `init()`.\n3. **blog.html**: Add the HTML container for the vector offset plot in section 6.5.\n\nLet me also check if `sklearn.decomposition.PCA` is already imported.\n\nLooking at precompute.py imports:\n- `from app.modeling import ...` includes `project_embeddings` which likely uses PCA internally, but PCA isn't directly imported in precompute.py\n\n\n- `numpy` is imported as `np`\n- `LANGUAGE_FAMILY_MAP` is already imported from `app.benchmarks`\n\nI need to add `from sklearn.decomposition import PCA` at the top of the file, then proceed with all three edits."}]}}
{"role":"assistant","message":{"content":[{"type":"text","text":"Now let me verify the edits look correct by checking the modified regions."}]}}
{"role":"assistant","message":{"content":[{"type":"text","text":"All three edits are complete with no linter errors. Here's a summary of what was changed:\n\n**1. `precompute.py`** — Added `from sklearn.decomposition import PCA` at the top. In `run_offset_invariance()`, after computing pairs, the function now finds the best pair (highest `mean_consistency`), collects per-language offset vectors (concept_b - concept_a), projects them to 2D via PCA, and saves the result as `vector_plot` in the output JSON — including per-language coordinates with family labels, the centroid point, and explained variance ratios.\n\n**2. `blog.js`** — Added `renderVectorOffsetExample(data)` which reads `data.vector_plot`, groups points by language family, creates a 2D scatter plot with one trace per family (colored by `FAMILY_COLORS`), and draws a thick red arrow from origin to the centroid with a triangle marker. The title displays the best pair and its consistency score. Also added the `safeRender(\"vectorOffset\", ...)` call right after `offsetStats` in `init()`.\n\n**3. `blog.html`** — Inserted a new `<div class=\"figure\">` block containing the `vectorOffsetPlot` chart div and Figure 11b caption, placed between the `offsetStats` badges and the existing `offsetChart` figure (Figure 11).\n\nTo see the new visualization, you'll need to re-run the precompute script to regenerate `offset_invariance.json` with the `vector_plot` field, then reload the blog page."}]}}