{"role":"user","message":{"content":[{"type":"text","text":"<user_query>\nUpdate the InterpretCognates frontend to support the new backend features. You need to update THREE files. Read each file first before editing.\n\nThe backend now has these NEW capabilities that the frontend needs to support:\n\n1. **Isotropy correction toggle**: The `/api/analyze` endpoint now accepts `isotropy_corrected: bool` and returns both raw and corrected similarity matrices\n2. **Mean-centered PCA**: The `/api/analyze` endpoint now returns `embedding_points_centered` (concept-meaning clusters) alongside the existing `embedding_points` (language-family clusters)\n3. **New experiment endpoints**: `/api/experiment/swadesh`, `/api/experiment/color-circle`, `/api/experiment/colexification`, `/api/experiment/phylogenetic`, `/api/experiment/neuron-overlap`, `/api/experiment/cognate-entropy`, `/api/cross-attention/per-head`, `/api/embed/layers`\n\n## File 1: `/Users/kylemathewson/InterpretCognates/backend/app/static/index.html`\n\nAdd the following to the HTML:\n\n1. **A toggle for isotropy correction** in the controls section (before the Analyze button):\n```html\n<div class=\"toggleRow\">\n  <label class=\"toggleLabel\">\n    <input type=\"checkbox\" id=\"isotropyToggle\" />\n    Isotropy-corrected similarity (ABTT)\n  </label>\n</div>\n```\n\n2. **A toggle for PCA mode** above the scatter plot section:\nAdd a `div` with class `vizToggle` right after the `<h2>Concept Manifold Cloud (PCA)</h2>`:\n```html\n<div class=\"vizToggle\">\n  <button id=\"pcaRawBtn\" class=\"toggleBtn active\">Language Clusters (Raw)</button>\n  <button id=\"pcaCenteredBtn\" class=\"toggleBtn\">Concept Clusters (Mean-Centered)</button>\n</div>\n```\n\n3. **An Experiments section** after all existing sections, before the closing `</main>` tag:\n```html\n<section class=\"experiments\">\n  <h2>Scientific Experiments</h2>\n  <p class=\"sectionNote\">\n    Run research experiments from the development roadmap. These use the full Swadesh corpus\n    and external validation data. Each experiment may take 1–5 minutes on first run.\n  </p>\n  <div class=\"experimentGrid\">\n    <div class=\"experimentCard\">\n      <h3>Swadesh Convergence</h3>\n      <p>Rank 100 core vocabulary concepts by cross-lingual embedding convergence — testing Swadesh's cultural stability hypothesis.</p>\n      <button id=\"runSwadeshBtn\" class=\"experimentBtn\">Run Experiment</button>\n      <div id=\"swadeshResult\" class=\"experimentResult\"></div>\n    </div>\n    <div class=\"experimentCard\">\n      <h3>Color Circle (Berlin & Kay)</h3>\n      <p>Project 11 basic color term centroids into 2D PCA — testing whether NLLB recovers the universal perceptual color circle.</p>\n      <button id=\"runColorBtn\" class=\"experimentBtn\">Run Experiment</button>\n      <div id=\"colorResult\" class=\"experimentResult\"></div>\n    </div>\n    <div class=\"experimentCard\">\n      <h3>Colexification (CLICS²)</h3>\n      <p>Compare cosine similarity of frequently colexified vs. never-colexified concept pairs — testing universal conceptual associations.</p>\n      <button id=\"runColexBtn\" class=\"experimentBtn\">Run Experiment</button>\n      <div id=\"colexResult\" class=\"experimentResult\"></div>\n    </div>\n    <div class=\"experimentCard\">\n      <h3>Phylogenetic Distance</h3>\n      <p>Compute embedding distance matrix across 40 languages over Swadesh vocabulary — preparation for Mantel test against ASJP.</p>\n      <button id=\"runPhyloBtn\" class=\"experimentBtn\">Run Experiment</button>\n      <div id=\"phyloResult\" class=\"experimentResult\"></div>\n    </div>\n  </div>\n</section>\n```\n\n## File 2: `/Users/kylemathewson/InterpretCognates/backend/app/static/styles.css`\n\nADD the following CSS at the end of the file (do NOT modify existing styles):\n\n```css\n\n.toggleRow {\n  display: flex;\n  align-items: center;\n  gap: 12px;\n}\n\n.toggleLabel {\n  display: flex;\n  flex-direction: row;\n  align-items: center;\n  gap: 8px;\n  font-size: 0.9rem;\n  color: #475569;\n  cursor: pointer;\n}\n\n.toggleLabel input[type=\"checkbox\"] {\n  width: 16px;\n  height: 16px;\n  accent-color: #4f46e5;\n}\n\n.vizToggle {\n  display: flex;\n  gap: 8px;\n  margin-bottom: 12px;\n}\n\n.toggleBtn {\n  background: #e2e8f0;\n  color: #475569;\n  font-size: 0.85rem;\n  padding: 6px 14px;\n  border-radius: 6px;\n  border: 1px solid #cbd5e1;\n  cursor: pointer;\n  font-weight: 500;\n  transition: all 0.15s ease;\n}\n\n.toggleBtn.active {\n  background: #4f46e5;\n  color: white;\n  border-color: #4f46e5;\n}\n\n.experiments {\n  margin-top: 32px;\n}\n\n.experimentGrid {\n  display: grid;\n  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));\n  gap: 16px;\n  margin-top: 12px;\n}\n\n.experimentCard {\n  border: 1px solid #e2e8f0;\n  border-radius: 10px;\n  padding: 16px;\n  background: #f8fafc;\n}\n\n.experimentCard h3 {\n  margin: 0 0 8px;\n  font-size: 1rem;\n  color: #1e293b;\n}\n\n.experimentCard p {\n  font-size: 0.88rem;\n  color: #64748b;\n  line-height: 1.5;\n  margin: 0 0 12px;\n}\n\n.experimentBtn {\n  background: #0f766e;\n  color: white;\n  font-size: 0.88rem;\n  padding: 8px 16px;\n  border-radius: 7px;\n  border: none;\n  cursor: pointer;\n  font-weight: 600;\n  transition: background 0.15s ease;\n}\n\n.experimentBtn:hover {\n  background: #115e59;\n}\n\n.experimentBtn:disabled {\n  background: #94a3b8;\n  cursor: not-allowed;\n}\n\n.experimentResult {\n  margin-top: 12px;\n  font-size: 0.88rem;\n  color: #334155;\n  line-height: 1.5;\n}\n\n.experimentResult .chart {\n  margin-top: 8px;\n  min-height: 300px;\n}\n\n.statHighlight {\n  display: inline-block;\n  background: #dbeafe;\n  color: #1e40af;\n  padding: 2px 8px;\n  border-radius: 4px;\n  font-weight: 600;\n  font-family: monospace;\n  font-size: 0.85rem;\n}\n\n.statRow {\n  display: flex;\n  justify-content: space-between;\n  padding: 4px 0;\n  border-bottom: 1px solid #f1f5f9;\n}\n```\n\n## File 3: `/Users/kylemathewson/InterpretCognates/backend/app/static/app.js`\n\nThis is the most complex update. The current file is ~698 lines. Add the following functionality:\n\n### 1. At the TOP of the file, after the existing const declarations (around line 14), add:\n\n```javascript\nconst isotropyToggle = document.getElementById(\"isotropyToggle\");\n```\n\n### 2. In the `runAnalysis()` function, update the payload to include isotropy flag:\n\nFind this code block:\n```javascript\nconst payload = {\n  concept: conceptInput.value.trim(),\n  source_lang: sourceLang,\n  target_langs: targetLangs,\n  context_template: contextTemplateInput.value.trim(),\n};\n```\n\nReplace it with:\n```javascript\nconst payload = {\n  concept: conceptInput.value.trim(),\n  source_lang: sourceLang,\n  target_langs: targetLangs,\n  context_template: contextTemplateInput.value.trim(),\n  isotropy_corrected: isotropyToggle.checked,\n};\n```\n\n### 3. In the `runAnalysis()` function, after `renderScatter(data.embedding_points, data.sentences);`, add:\n\n```javascript\n    // Store centered points for toggle\n    window._lastData = data;\n    window._pcaMode = \"raw\";\n```\n\n### 4. AFTER the existing `runBtn.addEventListener(\"click\", runAnalysis);` line (around line 689), ADD all of the following new code:\n\n```javascript\n\n// ---------------------------------------------------------------------------\n// PCA mode toggle\n// ---------------------------------------------------------------------------\nconst pcaRawBtn = document.getElementById(\"pcaRawBtn\");\nconst pcaCenteredBtn = document.getElementById(\"pcaCenteredBtn\");\n\nif (pcaRawBtn && pcaCenteredBtn) {\n  pcaRawBtn.addEventListener(\"click\", () => {\n    if (window._lastData) {\n      pcaRawBtn.classList.add(\"active\");\n      pcaCenteredBtn.classList.remove(\"active\");\n      renderScatter(window._lastData.embedding_points, window._lastData.sentences);\n    }\n  });\n  pcaCenteredBtn.addEventListener(\"click\", () => {\n    if (window._lastData && window._lastData.embedding_points_centered) {\n      pcaCenteredBtn.classList.add(\"active\");\n      pcaRawBtn.classList.remove(\"active\");\n      renderScatter(window._lastData.embedding_points_centered, window._lastData.sentences);\n    }\n  });\n}\n\n// ---------------------------------------------------------------------------\n// Scientific experiments\n// ---------------------------------------------------------------------------\n\nfunction showExperimentLoading(el, msg) {\n  el.innerHTML = `<div style=\"color:#64748b;font-style:italic\">${msg}</div>`;\n}\n\nfunction showExperimentError(el, err) {\n  el.innerHTML = `<div style=\"color:#dc2626\">Error: ${err}</div>`;\n}\n\n// --- Swadesh Convergence ---\nconst runSwadeshBtn = document.getElementById(\"runSwadeshBtn\");\nif (runSwadeshBtn) {\n  runSwadeshBtn.addEventListener(\"click\", async () => {\n    const resultEl = document.getElementById(\"swadeshResult\");\n    runSwadeshBtn.disabled = true;\n    runSwadeshBtn.textContent = \"Running...\";\n    showExperimentLoading(resultEl, \"Embedding 100 concepts × 40 languages... this may take several minutes.\");\n    try {\n      const resp = await fetch(\"/api/experiment/swadesh\", { method: \"POST\" });\n      if (!resp.ok) throw new Error(`API error ${resp.status}`);\n      const data = await resp.json();\n      renderSwadeshResult(resultEl, data);\n    } catch (err) {\n      showExperimentError(resultEl, err.message);\n    } finally {\n      runSwadeshBtn.disabled = false;\n      runSwadeshBtn.textContent = \"Run Experiment\";\n    }\n  });\n}\n\nfunction renderSwadeshResult(el, data) {\n  const ranking = data.convergence_ranking || [];\n  const top20 = ranking.slice(0, 20);\n  const bottom10 = ranking.slice(-10);\n\n  let html = `<p><strong>${data.num_concepts}</strong> concepts, <strong>${data.num_languages}</strong> languages, <strong>${data.total_embeddings}</strong> embeddings</p>`;\n  html += `<p><strong>Top 20 most convergent concepts:</strong></p>`;\n\n  const chartId = \"swadesh-bar-chart\";\n  html += `<div id=\"${chartId}\" class=\"chart\"></div>`;\n\n  html += `<p style=\"margin-top:12px\"><strong>Bottom 10 (least convergent):</strong></p><ol start=\"${ranking.length - 9}\">`;\n  bottom10.forEach((item) => {\n    html += `<li>${item.concept} — <span class=\"statHighlight\">${item.mean_similarity.toFixed(4)}</span></li>`;\n  });\n  html += `</ol>`;\n  el.innerHTML = html;\n\n  Plotly.newPlot(chartId, [{\n    type: \"bar\",\n    x: top20.map((d) => d.concept),\n    y: top20.map((d) => d.mean_similarity),\n    marker: { color: \"#4f46e5\" },\n    hovertemplate: \"<b>%{x}</b><br>mean similarity: %{y:.4f}<extra></extra>\",\n  }], {\n    margin: { l: 50, r: 20, t: 10, b: 80 },\n    height: 320,\n    xaxis: { tickangle: -40 },\n    yaxis: { title: \"Mean cross-lingual similarity\" },\n  }, { responsive: true });\n}\n\n// --- Color Circle ---\nconst runColorBtn = document.getElementById(\"runColorBtn\");\nif (runColorBtn) {\n  runColorBtn.addEventListener(\"click\", async () => {\n    const resultEl = document.getElementById(\"colorResult\");\n    runColorBtn.disabled = true;\n    runColorBtn.textContent = \"Running...\";\n    showExperimentLoading(resultEl, \"Embedding 11 color terms × 30 languages...\");\n    try {\n      const resp = await fetch(\"/api/experiment/color-circle\", { method: \"POST\" });\n      if (!resp.ok) throw new Error(`API error ${resp.status}`);\n      const data = await resp.json();\n      renderColorResult(resultEl, data);\n    } catch (err) {\n      showExperimentError(resultEl, err.message);\n    } finally {\n      runColorBtn.disabled = false;\n      runColorBtn.textContent = \"Run Experiment\";\n    }\n  });\n}\n\nfunction renderColorResult(el, data) {\n  const centroids = data.centroids || [];\n  const COLOR_HEX = {\n    black: \"#000000\", white: \"#cccccc\", red: \"#e53e3e\", green: \"#38a169\",\n    yellow: \"#ecc94b\", blue: \"#3182ce\", brown: \"#8B4513\", purple: \"#805ad5\",\n    pink: \"#ed64a6\", orange: \"#dd6b20\", grey: \"#a0aec0\",\n  };\n\n  const chartId = \"color-circle-chart\";\n  el.innerHTML = `<p><strong>${data.num_colors}</strong> color centroids from <strong>${data.num_languages}</strong> languages</p><div id=\"${chartId}\" class=\"chart\"></div>`;\n\n  Plotly.newPlot(chartId, [{\n    type: \"scatter\",\n    mode: \"markers+text\",\n    x: centroids.map((p) => p.x),\n    y: centroids.map((p) => p.y),\n    text: centroids.map((p) => p.label),\n    textposition: \"top center\",\n    marker: {\n      size: 18,\n      color: centroids.map((p) => COLOR_HEX[p.label] || \"#718096\"),\n      line: { width: 2, color: \"#1a202c\" },\n    },\n    textfont: { size: 13, color: \"#1a202c\" },\n    hovertemplate: \"<b>%{text}</b><br>PC1: %{x:.3f}<br>PC2: %{y:.3f}<extra></extra>\",\n  }], {\n    margin: { l: 50, r: 30, t: 10, b: 40 },\n    height: 400,\n    xaxis: { title: \"PC 1\", zeroline: true },\n    yaxis: { title: \"PC 2\", zeroline: true },\n  }, { responsive: true });\n}\n\n// --- Colexification ---\nconst runColexBtn = document.getElementById(\"runColexBtn\");\nif (runColexBtn) {\n  runColexBtn.addEventListener(\"click\", async () => {\n    const resultEl = document.getElementById(\"colexResult\");\n    runColexBtn.disabled = true;\n    runColexBtn.textContent = \"Running...\";\n    showExperimentLoading(resultEl, \"Computing colexification similarity distributions...\");\n    try {\n      const resp = await fetch(\"/api/experiment/colexification\", { method: \"POST\" });\n      if (!resp.ok) throw new Error(`API error ${resp.status}`);\n      const data = await resp.json();\n      renderColexResult(resultEl, data);\n    } catch (err) {\n      showExperimentError(resultEl, err.message);\n    } finally {\n      runColexBtn.disabled = false;\n      runColexBtn.textContent = \"Run Experiment\";\n    }\n  });\n}\n\nfunction renderColexResult(el, data) {\n  if (data.error) {\n    el.innerHTML = `<p style=\"color:#dc2626\">${data.error}</p>`;\n    return;\n  }\n  const chartId = \"colex-box-chart\";\n  let html = `<div class=\"statRow\"><span>Colexified pairs mean</span><span class=\"statHighlight\">${data.colexified_mean.toFixed(4)} ± ${data.colexified_std.toFixed(4)}</span></div>`;\n  html += `<div class=\"statRow\"><span>Non-colexified pairs mean</span><span class=\"statHighlight\">${data.non_colexified_mean.toFixed(4)} ± ${data.non_colexified_std.toFixed(4)}</span></div>`;\n  html += `<div class=\"statRow\"><span>Mann-Whitney U</span><span class=\"statHighlight\">${data.U_statistic.toFixed(1)}</span></div>`;\n  html += `<div class=\"statRow\"><span>p-value</span><span class=\"statHighlight\">${data.p_value < 0.001 ? data.p_value.toExponential(2) : data.p_value.toFixed(4)}</span></div>`;\n  html += `<div id=\"${chartId}\" class=\"chart\"></div>`;\n  el.innerHTML = html;\n\n  Plotly.newPlot(chartId, [\n    { y: data.colexified_sims, type: \"box\", name: \"Colexified\", marker: { color: \"#4f46e5\" } },\n    { y: data.non_colexified_sims, type: \"box\", name: \"Non-colexified\", marker: { color: \"#e53e3e\" } },\n  ], {\n    margin: { l: 50, r: 20, t: 10, b: 40 },\n    height: 300,\n    yaxis: { title: \"Mean cosine similarity\" },\n  }, { responsive: true });\n}\n\n// --- Phylogenetic ---\nconst runPhyloBtn = document.getElementById(\"runPhyloBtn\");\nif (runPhyloBtn) {\n  runPhyloBtn.addEventListener(\"click\", async () => {\n    const resultEl = document.getElementById(\"phyloResult\");\n    runPhyloBtn.disabled = true;\n    runPhyloBtn.textContent = \"Running...\";\n    showExperimentLoading(resultEl, \"Computing embedding distances across Swadesh vocabulary...\");\n    try {\n      const resp = await fetch(\"/api/experiment/phylogenetic\", { method: \"POST\" });\n      if (!resp.ok) throw new Error(`API error ${resp.status}`);\n      const data = await resp.json();\n      renderPhyloResult(resultEl, data);\n    } catch (err) {\n      showExperimentError(resultEl, err.message);\n    } finally {\n      runPhyloBtn.disabled = false;\n      runPhyloBtn.textContent = \"Run Experiment\";\n    }\n  });\n}\n\nfunction renderPhyloResult(el, data) {\n  const chartId = \"phylo-heatmap\";\n  const langNames = data.languages.map((code) => langName(code));\n\n  let html = `<p><strong>${data.num_languages}</strong> languages — embedding distance matrix over Swadesh vocabulary</p>`;\n  html += `<div id=\"${chartId}\" class=\"chart\"></div>`;\n  el.innerHTML = html;\n\n  Plotly.newPlot(chartId, [{\n    z: data.embedding_distance_matrix,\n    x: langNames,\n    y: langNames,\n    type: \"heatmap\",\n    colorscale: \"Viridis\",\n    hovertemplate: \"<b>%{y}</b> × <b>%{x}</b><br>distance: %{z:.4f}<extra></extra>\",\n    colorbar: { title: \"Cosine<br>distance\", thickness: 14, len: 0.5 },\n  }], {\n    margin: { l: 120, r: 20, t: 10, b: 120 },\n    height: 600,\n    xaxis: { tickangle: -45, tickfont: { size: 10 } },\n    yaxis: { tickfont: { size: 10 }, autorange: \"reversed\" },\n  }, { responsive: true });\n}\n```\n\nIMPORTANT INSTRUCTIONS:\n- Read each file before editing\n- For `index.html`: add the new HTML elements in the positions described above. Keep all existing HTML intact.\n- For `styles.css`: APPEND the new styles at the end of the file. Do not modify existing styles.\n- For `app.js`: Make the targeted edits described (add const, modify payload, add window._lastData, add all new code after the existing event listeners at the end). Do not modify existing functions.\n- Return a summary of changes made to each file.\n</user_query>"}]}}
{"role":"assistant","message":{"content":[{"type":"text","text":"Let me read all three files first, then make the edits."}]}}
{"role":"assistant","message":{"content":[{"type":"text","text":"Now I'll make all the edits. Let me start with all three files.\n\n**File 1: index.html** — three changes:\n\nNow I have all three files read. Let me make the edits as described.\n\n### File 1: index.html\n1. Add isotropy toggle in the controls section (before the Analyze button)\n2. Add PCA mode toggle after `<h2>Concept Manifold Cloud (PCA)</h2>`\n3. Add Experiments section before `</main>`\n\n### File 2: styles.css\nAppend new styles at the end\n\n### File 3: app.js\n1. Add `const isotropyToggle` after line 14\n2. Replace payload in runAnalysis to include isotropy_corrected\n\n\n3. Store the last embedding data and PCA mode state in window variables after rendering\n4. Wire up the PCA toggle and experiment buttons with their event listeners at the end of the file"}]}}
{"role":"assistant","message":{"content":[{"type":"text","text":"**File 2: styles.css** — append new styles:"}]}}
{"role":"assistant","message":{"content":[{"type":"text","text":"**File 3: app.js** — four targeted edits:"}]}}
{"role":"assistant","message":{"content":[{"type":"text","text":"All three files are updated. Here's a summary of changes:\n\n### `index.html`\n- **Isotropy toggle**: Added a checkbox (`#isotropyToggle`) with label \"Isotropy-corrected similarity (ABTT)\" in the controls section, just before the Analyze button.\n- **PCA mode toggle**: Added two buttons (`#pcaRawBtn`, `#pcaCenteredBtn`) in a `.vizToggle` div below the \"Concept Manifold Cloud (PCA)\" heading, allowing switching between raw language clusters and mean-centered concept clusters.\n- **Experiments section**: Added a full `<section class=\"experiments\">` before `</main>` with four experiment cards: Swadesh Convergence, Color Circle, Colexification, and Phylogenetic Distance — each with a run button and result container.\n\n### `styles.css`\n- **Appended** all new styles at the end of the file: `.toggleRow`, `.toggleLabel`, `.vizToggle`, `.toggleBtn` (with `.active` state), `.experiments`, `.experimentGrid`, `.experimentCard`, `.experimentBtn` (with hover/disabled states), `.experimentResult`, `.statHighlight`, and `.statRow`. No existing styles were modified.\n\n### `app.js`\n- **Line 14**: Added `const isotropyToggle` element reference.\n- **Payload**: Added `isotropy_corrected: isotropyToggle.checked` to the analysis request payload.\n- **After scatter render**: Added `window._lastData = data` and `window._pcaMode = \"raw\"` to store analysis results for PCA toggling.\n- **After existing event listeners**: Added PCA toggle logic (switches between `embedding_points` and `embedding_points_centered`) and all four experiment handlers (Swadesh, Color Circle, Colexification, Phylogenetic) with their respective render functions that produce Plotly charts."}]}}