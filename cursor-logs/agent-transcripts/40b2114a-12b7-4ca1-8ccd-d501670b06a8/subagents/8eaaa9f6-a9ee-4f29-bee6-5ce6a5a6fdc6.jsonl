{"role":"user","message":{"content":[{"type":"text","text":"<user_query>\nAdd per-language centroid PCA projections to the phylogenetic experiment backend endpoint.\n\n## Context\n\nThe file `/Users/kylemathewson/InterpretCognates/backend/app/main.py` has an endpoint `POST /api/experiment/phylogenetic` (around line 244). It currently:\n1. Loads the Swadesh corpus (100 concepts × 40 languages)\n2. Embeds all words via `embed_text_batch`\n3. Builds `concept_embeddings` dict: {concept_name: {lang_code: np.ndarray}}\n4. Computes embedding distance matrix via `compute_swadesh_embedding_distances`\n5. Computes MDS projection via `mds_projection`\n6. Computes dendrogram via `hierarchical_clustering_data`\n7. Returns all of the above\n\n## Task\n\nAdd per-language centroid PCA projections to this endpoint so the frontend can render a 3D PCA scatter with Raw/Centered toggle. Specifically:\n\n1. **In `/Users/kylemathewson/InterpretCognates/backend/app/modeling.py`**, there's already a function `project_embeddings_mean_centered(vectors, labels, language_ids)` that:\n   - Takes a list of vectors, labels, and language_ids\n   - Returns `{\"raw\": [...points...], \"centered\": [...points...], \"method\": \"cosine_pca\"|\"mean_centered\"}`\n   - Each point has `{label, x, y, z}`\n   - When every language has exactly 1 sample, it falls back to cosine-space PCA (L2-normalize before PCA)\n   - When multiple samples per language exist, it does proper per-language mean subtraction\n\n2. **In the phylogenetic endpoint in `main.py`**, after computing `concept_embeddings`, compute per-language centroid vectors:\n   ```python\n   # Compute per-language centroids (mean embedding across all concepts)\n   lang_centroids = []\n   for lang in languages:\n       vecs = [concept_embeddings[c][lang] for c in concept_embeddings if lang in concept_embeddings[c]]\n       lang_centroids.append(np.mean(vecs, axis=0))\n   ```\n   Then call `project_embeddings_mean_centered(lang_centroids, languages, languages)` to get both raw and centered PCA points.\n\n3. Add the PCA results to the return dict:\n   ```python\n   \"pca_raw\": pca_result[\"raw\"],\n   \"pca_centered\": pca_result[\"centered\"],\n   \"pca_method\": pca_result[\"method\"],\n   ```\n\n4. You'll need to import `project_embeddings_mean_centered` from `.modeling` in `main.py` — check if it's already imported. If not, add it to the existing import block from `.modeling`.\n\n## Important\n- Do NOT change any existing return fields\n- Do NOT change any other endpoints\n- The `project_embeddings_mean_centered` function already exists and handles the degenerate case (1 sample per language → cosine PCA). Since we're computing centroids (1 per language), it will use cosine PCA.\n- Use a virtual environment: the project uses `/Users/kylemathewson/InterpretCognates/backend/venv`\n\n</user_query>"}]}}
{"role":"assistant","message":{"content":[{"type":"text","text":"Let me read the relevant files to understand the current state of the code."}]}}
{"role":"assistant","message":{"content":[{"type":"text","text":"The function is already imported. I just need to add the centroid computation and PCA projection to the phylogenetic endpoint's return value.\n\nGood. `project_embeddings_mean_centered` is already imported at line 20. Now I need to add the per-language centroid PCA computation to the phylogenetic endpoint. Let me make the edit."}]}}
{"role":"assistant","message":{"content":[{"type":"text","text":"Let me verify the final result looks correct."}]}}
{"role":"assistant","message":{"content":[{"type":"text","text":"Done. Here's what was added to the phylogenetic endpoint in `main.py`:\n\n- **Lines 278–281**: Computes per-language centroids by averaging each language's embeddings across all concepts.\n- **Line 283**: Calls `project_embeddings_mean_centered` (already imported at line 20) with the centroids. Since there's exactly 1 centroid per language, it will use cosine-space PCA (L2-normalize → PCA).\n- **Lines 291–293**: Adds `pca_raw`, `pca_centered`, and `pca_method` to the response — all existing return fields are preserved."}]}}