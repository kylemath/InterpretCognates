{"role":"user","message":{"content":[{"type":"text","text":"<user_query>\nSearch the codebase at /Users/kylemathewson/InterpretCognates for all code related to generating the Mantel test scatter plot (Figure 7) that shows NLLB Embedding Distance vs ASJP Phonetic Distance. Look for:\n1. Python scripts that generate this plot or compute the Mantel test\n2. Any data files (CSV, JSON, etc.) that contain the ASJP phonetic distance and NLLB embedding distance data\n3. Any JavaScript code in the blog that renders this chart interactively\n4. The route/endpoint that serves this data\n\nBe very thorough - check all Python files, JS files, HTML templates, and data directories. Return the full paths and relevant code snippets.\n</user_query>"}]}}
{"role":"assistant","message":{"content":[{"type":"text","text":"Searching the codebase for Mantel test scatter plot (Figure 7) code and data. Running parallel searches."}]}}
{"role":"assistant","message":{"content":[{"type":"text","text":"Reading key files for the Mantel test scatter plot implementation:"}]}}
{"role":"assistant","message":{"content":[{"type":"text","text":"Checking how the blog loads the Mantel test data and searching for routes that serve it:"}]}}
{"role":"assistant","message":{"content":[{"type":"text","text":"Checking the route that serves the phylogenetic data:"}]}}
{"role":"assistant","message":{"content":[{"type":"text","text":"## Summary of Mantel Test Scatter Plot (Figure 7) Implementation\n\n### 1. Python scripts — Mantel test computation\n\n**`/Users/kylemathewson/InterpretCognates/backend/app/benchmarks.py`**\n\n- `mantel_test()` function (lines 178-208):\n  - Computes Spearman correlation between two distance matrices\n  - Uses permutation test for significance (default 9999 permutations)\n  - Returns `rho`, `p_value`, and `permutations`\n\n```python:178-208:backend/app/benchmarks.py\ndef mantel_test(\n    dist_a: np.ndarray, dist_b: np.ndarray, permutations: int = 9999\n) -> dict[str, float]:\n    \"\"\"Mantel test: correlation between two distance matrices.\n\n    Uses Spearman rank correlation on the upper triangle, with a\n    permutation test for significance.\n\n    Returns dict with keys: rho, p_value, permutations.\n    \"\"\"\n    n = dist_a.shape[0]\n    assert dist_a.shape == dist_b.shape == (n, n), \"Distance matrices must be square and same size\"\n\n    idx_upper = [(i, j) for i in range(n) for j in range(i + 1, n)]\n    a_flat = np.array([dist_a[i, j] for i, j in idx_upper])\n    b_flat = np.array([dist_b[i, j] for i, j in idx_upper])\n\n    rho_obs, _ = spearmanr(a_flat, b_flat)\n\n    count_ge = 0\n    rng = np.random.default_rng(42)\n    for _ in range(permutations):\n        perm = rng.permutation(n)\n        b_perm = dist_b[np.ix_(perm, perm)]\n        b_perm_flat = np.array([b_perm[i, j] for i, j in idx_upper])\n        rho_perm, _ = spearmanr(a_flat, b_perm_flat)\n        if rho_perm >= rho_obs:\n            count_ge += 1\n\n    p_value = (count_ge + 1) / (permutations + 1)\n    return {\"rho\": float(rho_obs), \"p_value\": float(p_value), \"permutations\": permutations}\n```\n\n- `compute_swadesh_embedding_distances()` function (lines 220-249):\n  - Computes mean cosine distance across Swadesh concepts for each language pair\n  - Returns N×N distance matrix\n\n- `compute_asjp_distance_matrix()` function (lines 785-822):\n  - Approximates ASJP LDND phonetic distance matrix based on linguistic taxonomy\n  - Uses language family mappings and published ASJP benchmarks\n  - Returns distance matrix and filtered language list\n\n**`/Users/kylemathewson/InterpretCognates/backend/app/main.py`**\n\n- `/api/experiment/phylogenetic` endpoint (lines 324-387):\n  - POST endpoint that computes embedding distances and runs Mantel test\n  - Calls `mantel_test()` with embedding and ASJP distance matrices\n  - Returns results including `mantel_test` object with scatter plot data\n\n```python:364-374:backend/app/main.py\n    asjp_dist, asjp_langs = compute_asjp_distance_matrix(languages)\n    mantel_result = None\n    if len(asjp_langs) >= 4:\n        lang_idx = {l: i for i, l in enumerate(languages)}\n        asjp_indices = [lang_idx[l] for l in asjp_langs]\n        emb_dist_subset = embedding_dist[np.ix_(asjp_indices, asjp_indices)]\n        mantel_result = mantel_test(emb_dist_subset, asjp_dist, permutations=999)\n        mantel_result[\"num_languages\"] = len(asjp_langs)\n        mantel_result[\"languages\"] = asjp_langs\n        mantel_result[\"asjp_distance_matrix\"] = asjp_dist.tolist()\n        mantel_result[\"embedding_distance_subset\"] = emb_dist_subset.tolist()\n```\n\n- `/api/results/phylogenetic` endpoint (lines 148-150):\n  - GET endpoint that serves precomputed results from JSON file\n\n**`/Users/kylemathewson/InterpretCognates/backend/app/scripts/precompute.py`**\n\n- `run_phylogenetic()` function (lines 138-177):\n  - Precomputes phylogenetic analysis including Mantel test\n  - Saves results to `phylogenetic.json`\n\n### 2. Data files\n\n**`/Users/kylemathewson/InterpretCognates/backend/app/data/results/phylogenetic.json`**\n\n- Contains precomputed Mantel test results\n- Structure includes:\n  - `mantel_test.rho`: Spearman correlation coefficient\n  - `mantel_test.p_value`: Permutation p-value\n  - `mantel_test.num_languages`: Number of languages in test\n  - `mantel_test.languages`: List of language codes\n  - `mantel_test.asjp_distance_matrix`: ASJP distance matrix (2D array)\n  - `mantel_test.embedding_distance_subset`: NLLB embedding distance matrix (2D array)\n\nExample from the file (lines 39106-39110):\n```json\n\"mantel_test\": {\n  \"rho\": 0.1163210024895722,\n  \"p_value\": 0.009,\n  \"permutations\": 999,\n  \"num_languages\": 71,\n  ...\n}\n```\n\n### 3. JavaScript code — interactive chart rendering\n\n**`/Users/kylemathewson/InterpretCognates/backend/app/static/blog.js`**\n\n- `renderMantelTest()` function (lines 617-673):\n  - Renders Figure 7 scatter plot using Plotly\n  - Extracts upper triangle from both distance matrices\n  - Creates scatter plot with ASJP distance on x-axis, NLLB embedding distance on y-axis\n\n```javascript:617-673:backend/app/static/blog.js\nfunction renderMantelTest(data) {\n  const statsEl = document.getElementById(\"mantelStats\");\n  const scatterEl = document.getElementById(\"mantelScatter\");\n\n  if (!data || !data.mantel_test) {\n    statsEl.innerHTML = \"<p>Mantel test data not available.</p>\";\n    scatterEl.innerHTML = \"<p>No data</p>\";\n    return;\n  }\n\n  const m = data.mantel_test;\n  const sig = m.p_value < 0.01;\n\n  statsEl.innerHTML = `\n    <div class=\"stat-badge ${sig ? 'significant' : ''}\">\n      <span class=\"stat-value\">&rho; = ${m.rho.toFixed(3)}</span>\n      <span class=\"stat-label\">Spearman correlation</span>\n    </div>\n    <div class=\"stat-badge ${sig ? 'significant' : ''}\">\n      <span class=\"stat-value\">p ${m.p_value < 0.001 ? '< 0.001' : '= ' + m.p_value.toFixed(4)}</span>\n      <span class=\"stat-label\">Permutation p-value</span>\n    </div>\n    <div class=\"stat-badge\">\n      <span class=\"stat-value\">${m.num_languages}</span>\n      <span class=\"stat-label\">Languages</span>\n    </div>\n    <div class=\"stat-badge\">\n      <span class=\"stat-value\">${m.permutations}</span>\n      <span class=\"stat-label\">Permutations</span>\n    </div>\n  `;\n\n  if (m.embedding_distance_subset && m.asjp_distance_matrix) {\n    const n = m.num_languages;\n    const embFlat = [], asjpFlat = [], pairLabels = [];\n    for (let i = 0; i < n; i++) {\n      for (let j = i + 1; j < n; j++) {\n        embFlat.push(m.embedding_distance_subset[i][j]);\n        asjpFlat.push(m.asjp_distance_matrix[i][j]);\n        pairLabels.push(langName(m.languages[i]) + \" — \" + langName(m.languages[j]));\n      }\n    }\n\n    Plotly.newPlot(scatterEl, [{\n      type: \"scatter\",\n      mode: \"markers\",\n      x: asjpFlat, y: embFlat, text: pairLabels,\n      marker: { size: 4, color: ACCENT, opacity: 0.5 },\n      hovertemplate: \"%{text}<br>ASJP: %{x:.3f}<br>Embedding: %{y:.3f}<extra></extra>\",\n    }], baseLayout({\n      height: 360,\n      xaxis: { title: \"ASJP Phonetic Distance\" },\n      yaxis: { title: \"NLLB Embedding Distance\" },\n      margin: { l: 60, r: 20, t: 10, b: 50 },\n    }), PLOTLY_CFG);\n  }\n}\n```\n\n- Data loading (line 1720):\n  - Fetches phylogenetic data via `/api/results/phylogenetic`\n  - Calls `renderMantelTest()` at line 1762\n\n**`/Users/kylemathewson/InterpretCognates/backend/app/static/validation.js`**\n\n- `renderMantelResults()` function (lines 846-895):\n  - Alternative rendering function for validation page\n  - Similar scatter plot implementation with slightly different styling\n\n### 4. HTML template\n\n**`/Users/kylemathewson/InterpretCognates/backend/app/static/blog.html`**\n\n- Figure 7 section (lines 530-558):\n  - Contains description of Mantel test\n  - HTML structure with `mantelStats` and `mantelScatter` divs\n  - Figure caption identifying it as \"Figure 7\"\n\n```html:530-558:backend/app/static/blog.html\n  <section class=\"prose\">\n    <h3>Mantel Test</h3>\n    <p>\n      The Mantel test directly quantifies the correlation between NLLB's embedding distance\n      matrix and the ASJP phonetic distance matrix. A significant positive correlation\n      would demonstrate that the model has implicitly learned genealogical language\n      relationships without any training signal about linguistic phylogeny.\n    </p>\n  </section>\n\n  <div id=\"mantelResults\" class=\"prose\">\n    <div class=\"stat-row\" id=\"mantelStats\">\n      <div class=\"loading-placeholder\"><span class=\"spinner\"></span> Loading&hellip;</div>\n    </div>\n  </div>\n\n  <div class=\"figure\">\n    <div class=\"figure-inner\">\n      <div id=\"mantelScatter\" class=\"chart chart-short\">\n        <div class=\"loading-placeholder\"><span class=\"spinner\"></span> Loading&hellip;</div>\n      </div>\n    </div>\n    <p class=\"figure-caption\">\n      <strong>Figure 7.</strong> Mantel test scatter plot &mdash; NLLB embedding distance\n      vs. ASJP phonetic distance for each language pair. Each point represents one entry\n      in the upper triangle of both matrices.\n    </p>\n  </div>\n```\n\n### 5. Routes/endpoints\n\n1. `GET /api/results/phylogenetic` — serves precomputed results from `phylogenetic.json`\n2. `POST /api/experiment/phylogenetic` — computes Mantel test on-demand and returns results\n\n### Summary\n\n- Python computation: `benchmarks.py` (`mantel_test()`, `compute_asjp_distance_matrix()`, `compute_swadesh_embedding_distances()`)\n- API endpoints: `main.py` (GET and POST endpoints)\n- Data storage: `backend/app/data/results/phylogenetic.json`\n- Frontend rendering: `blog.js` (`renderMantelTest()`)\n- HTML structure: `blog.html` (Figure 7 section)\n\nThe scatter plot shows ASJP Phonetic Distance (x-axis) vs NLLB Embedding Distance (y-axis) for each language pair, with each point representing one entry from the upper triangle of both distance matrices."}]}}