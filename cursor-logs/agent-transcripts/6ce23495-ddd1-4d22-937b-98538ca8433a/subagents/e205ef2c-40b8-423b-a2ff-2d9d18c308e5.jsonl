{"role":"user","message":{"content":[{"type":"text","text":"<user_query>\nExplore the directory /Users/kylemathewson/InterpretCognates/backend/app/ thoroughly. I need to understand:\n1. All files and their purposes\n2. The Flask/web app route structure - what pages exist\n3. What analysis is being done (button handlers, computation logic)\n4. What templates/HTML exist and what they render\n5. What data/graphs are being generated\n\nReturn a comprehensive summary of every file, the routes, the analysis functions, and how data flows from button clicks to results/graphs.\n</user_query>"}]}}
{"role":"assistant","message":{"content":[{"type":"text","text":"Exploring `/Users/kylemathewson/InterpretCognates/backend/app/` to map files, routes, analysis logic, templates, and data flow. Starting with a directory structure scan."}]}}
{"role":"assistant","message":{"content":[{"type":"text","text":"Reading key files to understand the structure:"}]}}
{"role":"assistant","message":{"content":[{"type":"text","text":"Reading JavaScript files to understand frontend interactions:"}]}}
{"role":"assistant","message":{"content":[{"type":"text","text":"Checking data files to understand the data structure:"}]}}
{"role":"assistant","message":{"content":[{"type":"text","text":"## Comprehensive Summary of `/backend/app/` Directory\n\n### 1. File Structure & Purposes\n\n**Core Application Files:**\n- **`__init__.py`** - Empty (package marker)\n- **`main.py`** (541 lines) - FastAPI app with routes and endpoints\n- **`modeling.py`** (399 lines) - NLLB model operations (embedding, translation, attention)\n- **`benchmarks.py`** (823 lines) - Validation experiments and metrics\n\n**Static Files (Frontend):**\n- **`static/index.html`** - Main analysis page\n- **`static/swadesh_detail.html`** - Swadesh convergence analysis page\n- **`static/validation.html`** - Validation experiments page\n- **`static/app.js`** (1,257 lines) - Main page JavaScript\n- **`static/swadesh_detail.js`** (622 lines) - Swadesh detail page logic\n- **`static/validation.js`** (1,037 lines) - Validation page logic\n- **`static/styles.css`** - Main stylesheet\n- **`static/swadesh_detail.css`** - Swadesh detail styles\n- **`static/validation.css`** - Validation page styles\n\n**Data Files:**\n- **`data/swadesh_100.json`** - Swadesh 100-item corpus (142 languages, 101 concepts)\n- **`data/non_swadesh_60.json`** - Non-Swadesh comparison corpus\n- **`data/color_terms.json`** - Berlin & Kay color terms\n\n**Scripts:**\n- **`scripts/expand_swadesh_corpus.py`** - Corpus expansion utility\n\n---\n\n### 2. Flask/Web App Route Structure\n\n**FastAPI application** (not Flask) with these routes:\n\n#### Page Routes (GET):\n- **`/`** → Serves `index.html` (main analysis page)\n- **`/swadesh`** → Serves `swadesh_detail.html` (Swadesh convergence analysis)\n- **`/validation`** → Serves `validation.html` (validation experiments)\n\n#### Data Routes (GET):\n- **`/api/data/swadesh`** → Returns Swadesh corpus JSON\n- **`/api/data/non-swadesh`** → Returns non-Swadesh corpus JSON\n\n#### Analysis Endpoints (POST):\n- **`/api/analyze`** → Core concept analysis (embeddings, similarity, attention)\n- **`/api/embed/layers`** → Per-layer embeddings\n- **`/api/cross-attention/per-head`** → Per-head cross-attention maps\n\n#### Experiment Endpoints (POST):\n- **`/api/experiment/swadesh`** → Swadesh convergence ranking\n- **`/api/experiment/phylogenetic`** → Phylogenetic distance analysis\n- **`/api/experiment/cognate-entropy`** → Cognate entropy analysis\n- **`/api/experiment/color-circle`** → Berlin & Kay color circle projection\n- **`/api/experiment/colexification`** → CLICS² colexification test\n- **`/api/experiment/neuron-overlap`** → Neuron activation overlap\n- **`/api/experiment/swadesh-comparison`** → Swadesh vs non-Swadesh comparison\n- **`/api/experiment/conceptual-store-metric`** → Conceptual store metric\n- **`/api/experiment/offset-invariance`** → Semantic offset invariance test\n\n---\n\n### 3. Analysis Functions & Computation Logic\n\n#### Core Modeling (`modeling.py`):\n- **`embed_text()`** - Single text embedding via NLLB encoder\n- **`embed_text_batch()`** - Batch embeddings (sorted by language)\n- **`embed_text_all_layers()`** - Per-layer embeddings\n- **`translate_text()`** - NLLB translation\n- **`cross_attention_map()`** - Cross-attention between source/target\n- **`cross_attention_map_per_head()`** - Per-head attention analysis\n- **`sentence_similarity_matrix()`** - Cosine similarity matrix\n- **`sentence_similarity_matrix_corrected()`** - Isotropy-corrected similarity (ABTT)\n- **`project_embeddings()`** - PCA projection (3D)\n- **`project_embeddings_mean_centered()`** - Mean-centered PCA (language vs concept clusters)\n- **`abtt_correct()`** - Anisotropy correction (remove top-k PCA components)\n- **`attention_entropy()`** - Attention entropy calculation\n- **`neuron_overlap_matrix()`** - FFN neuron activation overlap\n\n#### Benchmark Functions (`benchmarks.py`):\n- **`swadesh_convergence_ranking()`** - Rank concepts by cross-lingual similarity\n- **`compute_swadesh_embedding_distances()`** - Language-pair distance matrix\n- **`mds_projection()`** - Multidimensional scaling\n- **`hierarchical_clustering_data()`** - Dendrogram data\n- **`colexification_test()`** - Mann-Whitney U test (colexified vs non-colexified)\n- **`mantel_test()`** - Correlation between embedding and ASJP distances\n- **`swadesh_vs_non_swadesh_comparison()`** - Comparison test\n- **`conceptual_store_metric()`** - Between/within concept distance ratio\n- **`semantic_offset_invariance()`** - Cross-lingual offset vector parallelism\n- **`family_concept_maps()`** - Per-family concept space projections\n\n---\n\n### 4. Templates/HTML & What They Render\n\n#### **`index.html`** (Main Analysis Page):\n- Hero section with navigation\n- Controls:\n  - Concept input\n  - Source language selector\n  - Context template input\n  - Language picker (80+ languages, grouped by family)\n  - Isotropy correction toggle\n- Sections:\n  1. Translation outputs (all target languages)\n  2. Concept Manifold Cloud (3D PCA scatter plot) - toggleable raw/centered\n  3. Cross-Language Similarity Matrix (heatmap)\n  4. Source Token Alignment (unified heatmap across languages)\n  5. Token-Pair Detail (selectable per-language attention matrix)\n  6. Scientific Experiments (4 experiment cards)\n\n#### **`swadesh_detail.html`** (Swadesh Convergence Analysis):\n- Header with stats bar\n- Controls:\n  - Group by category toggle\n  - Comparison bars toggle\n  - Category filter dropdown\n  - Isotropy correction toggle\n- Sections:\n  1. Concept List (ranked table with embedding/ortho/phonetic scores)\n  2. Variance Decomposition (scatter plots: embedding vs orthographic/phonetic)\n  3. Category Summary (bar chart by semantic category)\n  4. Methodology explanation\n\n#### **`validation.html`** (Validation Experiments):\n- Header with navigation\n- Warning banner about compute time\n- 6 experiment panels:\n  1. Isotropy Correction Test\n  2. Swadesh vs Non-Swadesh Comparison\n  3. Colexification Test (CLICS²)\n  4. Conceptual Store Metric\n  5. Phylogenetic Distance & Mantel Test\n  6. Semantic Offset Invariance\n\n---\n\n### 5. Data Flow: Button Clicks → Results/Graphs\n\n#### Main Analysis Flow (`app.js`):\n\n**Button: \"Analyze Concept Geometry\"**\n1. User input: concept, source language, target languages, context template, isotropy toggle\n2. POST `/api/analyze` with payload\n3. Backend (`main.py:analyze()`):\n   - Formats source sentence with template\n   - Translates to all target languages\n   - Embeds all sentences\n   - Computes cross-attention maps\n   - Projects embeddings (PCA raw + mean-centered)\n   - Computes similarity matrix\n4. Frontend receives JSON response\n5. Renders:\n   - Translations list (`renderTranslations()`)\n   - 3D PCA scatter plot (`renderScatter()`)\n   - Similarity heatmap (`renderSimilarity()`)\n   - Attention maps (`renderAttentionMaps()`)\n\n**Experiment Buttons:**\n- **Swadesh Convergence**: POST `/api/experiment/swadesh` → Renders bar chart of top 20 concepts\n- **Color Circle**: POST `/api/experiment/color-circle` → Renders 2D PCA scatter of color centroids\n- **Colexification**: POST `/api/experiment/colexification` → Renders box plot comparison\n- **Phylogenetic**: POST `/api/experiment/phylogenetic` → Renders:\n  - Distance matrix heatmap\n  - MDS 2D projection\n  - Hierarchical clustering dendrogram\n  - 3D PCA of language centroids\n  - Concept maps per family\n  - Mantel test scatter plot\n\n#### Swadesh Detail Flow (`swadesh_detail.js`):\n\n**Page Load:**\n1. Checks localStorage for cached results\n2. If missing, shows \"Run Experiment\" button\n3. Loads corpus data (`/api/data/swadesh`)\n4. Computes orthographic/phonetic similarity scores\n5. Enriches concepts with scores and ranks\n6. Renders:\n   - Concept list table\n   - Variance decomposition scatter plots\n   - Category summary bar chart\n\n**Isotropy Toggle:**\n1. POST `/api/experiment/swadesh` with `isotropy_corrected: true`\n2. Recomputes convergence ranking\n3. Updates all visualizations\n\n#### Validation Flow (`validation.js`):\n\n**Each Panel Button:**\n1. Disables button, shows loading indicator\n2. POST to respective endpoint\n3. Backend runs experiment (2-5 minutes)\n4. Returns results JSON\n5. Renders:\n   - Statistics badges\n   - Charts (bar, box, scatter, heatmap, dendrogram, 3D PCA)\n   - Significance indicators\n\n---\n\n### 6. Key Data Structures & Graphs Generated\n\n**Graphs Generated:**\n1. **3D PCA Scatter Plots** - Concept/language embeddings in 3D space\n2. **Similarity Heatmaps** - Cross-language cosine similarity matrices\n3. **Attention Heatmaps** - Token alignment weights (unified + per-language detail)\n4. **Bar Charts** - Concept rankings, category summaries\n5. **Box Plots** - Distribution comparisons (Swadesh vs non-Swadesh, colexified vs non-colexified)\n6. **Scatter Plots** - Variance decomposition, Mantel test correlations\n7. **Dendrograms** - Hierarchical clustering trees\n8. **MDS Projections** - 2D embeddings preserving global distances\n9. **Concept Maps** - Per-family PCA projections of concept centroids\n\n**Data Structures:**\n- **Concept Embeddings**: `{concept_name: {lang_code: np.ndarray}}`\n- **Distance Matrices**: `np.ndarray` (N×N cosine distances)\n- **Attention Maps**: `{source_tokens: [], target_tokens: [], values: [[...]]}`\n- **Convergence Rankings**: `[{concept, mean_similarity, std, n_languages}, ...]`\n\n---\n\n### Summary\n\nThe app analyzes how multilingual neural networks (NLLB-200) represent concepts across languages. It provides:\n- Interactive concept analysis with visualizations\n- Swadesh convergence ranking\n- Validation experiments against linguistic benchmarks\n- Attention analysis showing token alignments\n- Phylogenetic structure analysis\n\nThe architecture separates:\n- **Backend**: FastAPI with modeling/benchmark modules\n- **Frontend**: Vanilla JavaScript with Plotly.js for visualizations\n- **Data**: JSON corpora (Swadesh, color terms, non-Swadesh)\n\nAll experiments are computationally intensive (2-5 minutes) and involve embedding thousands of words across 40-142 languages."}]}}